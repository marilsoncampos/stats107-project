---
title: "The Buffet Bet - Basket of Funds vs. All Passive"
subtitle: "Stats 107 Final Project"
author: "David Wihl"
date: "December 6, 2016"
abstract: |
  Ten years ago, Warren Buffett made a famous : the ultimate passive investment, the Vanguard S&P 500 Index Fund Admiral (VFIAX), vs. a basket of funds determined by a team of hedge fund experts. Whoever had a lower return after ten years would donate $1 million to the charity of choice of the winner. After eight years, it looks increasingly likely that Buffett will win the bet.
output: pdf_document
linkcolor: blue
---
\begin{center}
\textbf{Type: Simulating a trading strategy.}
\end{center}

```{r, echo=FALSE, message=FALSE,warning=FALSE}
# Load libraries
library(ggplot2)
library(quantmod)
library(knitr)
```

# Introduction


TODO

# Methods


## Importing List of Vanguard Mutual Funds

From Vanguard, I obtain a list of the 168 currently offered mutual funds
including expense ratio. I converted this into a CSV for easy import into
R.

Once the list of funds was imported, I used `quantmod` to read in
historical daily adjusted data for the entire date range available
from Yahoo. Since the earliest available date was November 13, 2000,
I chose an even 16 year end period, ending November 13, 2016. While more
data would have been preferable, I felt that this was a reasonable sample
given it included two significant market corrections in 2001 and again 2009.

Given the size of data (168 securities, 16 years of daily data) I cached the data locally to allow fast iteration on many models. See appendix for all code.


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#
# Import List of Securities
#
loadRData = function(filename) {
  # Source: http://stackoverflow.com/questions/5577221/how-can-i-load-an-object-into-a-variable-name-that-i-specify-from-an-r-data-file
  load(filename)
  get(ls()[ls()!="filename"])
}
fromDate = "2000-11-13"
toDate   = "2016-11-13"
funds    = read.csv("data/vanguard.csv",header = T, stringsAsFactors = F)
# Load from previously cached download
stockDataEnv= loadRData("data/stockData.RData")
fundData = mget(funds$Ticker,stockDataEnv)
```

## Summary Statistics 

Several simple descriptive statistics were created: Total Return, Average
Daily Return, Standard Deviation / Risk, Sharpe Ratio and CAGR. The following
two tables summarize the top mutual funds. 

Interestingly, in performing these summary statistics, I determined that
`quantmod` does not use adjusted price to calculate returns. So, basically, it is
wrong. I found this going through the quantmod sources and then confirmed
it at http://stackoverflow.com/questions/34772616/r-function-periodreturn-not-computing-returns-using-adjusted-closing-prices  As an extra precaution, I adjusted values upon retrieving the data using `getSymbol`.



```{r, echo=FALSE}
#
# Generate Summary Statistics
#
for (i in 1:nrow(funds)) {
  sym = funds$Ticker[i]
  data = eval(parse(text=paste("fundData$",sym,sep="")))
  if(!is.null(data)){
    # we have the stockdata; Calculate summary statistics
    funds$startDate[i] = as.Date(index(data[1]))
    funds$endDate[i] = as.Date(index(last(data[])))
    startPrice = as.numeric(Ad(data[1]))
    endPrice = as.numeric(Ad(last(data[])))
    funds$totalRet[i] = (endPrice - startPrice) / startPrice
    dailyRets = dailyReturn(Ad(data))
    funds$stdDev[i] = sd(dailyRets)
    funds$avgRet[i] = mean(dailyRets)
    funds$Sharpe[i] = funds$avgRet[i] / funds$stdDev[i]
    # CAGR
    years =  as.numeric((as.Date(funds$endDate[i]) -
                           as.Date(funds$startDate[i])))/365
    funds$CAGR[i] = ((endPrice / startPrice)^(1/years)) - 1

  }
}
```

```{r, echo=FALSE}
#
# Generate Tables of Top Performers
#
colsToDisplay = c("Ticker","Fund.Name","Expenses","CAGR","Sharpe")
kable(head(funds[order(-funds$Sharpe),colsToDisplay]), caption="Best Sharpe Ratio",
      row.names = F,digits=2)

kable(head(funds[order(funds$Sharpe),colsToDisplay]), caption="Worst Sharpe Ratio",
      row.names = F,digits=2)

kable(head(funds[order(-funds$CAGR),colsToDisplay]), caption="Best CAGR",
      row.names = F,digits=2)

kable(head(funds[order(funds$CAGR),colsToDisplay]), caption="Worst CAGR",
      row.names = F,digits=2)

```

VMMSX is particularly bad: high expenses, low returns and low Sharpe Ratio.

```{r, echo=FALSE, fig.height=5}
#
# Show histograms with base VFIAX case
#
#par(mfrow=c(3,1), mar=rep(2,2))

# CAGR
hist(funds$CAGR,main="CAGR (all funds)",xlab="")
abline(v=funds[funds$Ticker=="VFIAX",]$CAGR,col="blue")

# Standard Deviation
hist(funds$stdDev,main="Standard Deviation (all funds)",xlab="")
abline(v=funds[funds$Ticker=="VFIAX",]$stdDev,col="blue")

# Sharpe Ratio
hist(funds$Sharpe,main="Sharpe Ratio (all funds)",xlab="")
abline(v=funds[funds$Ticker=="VFIAX",]$Sharpe,col="blue")
```


## Expense Ratios

Every mutual fund has expense ratios which is the principle way that a 
company like Vanguard makes money. An expense ratio is a mutual fund's 
annual operating expense, expressed as a percentage of the fund's average
net assets. It's calculated annually and removed from the fund's earnings
before they're distributed to investors, directly reducing investors'
returns. Since expenses were taken directly from assets, no special calculations
needed to be made for expenses, since the costs were already reflected in 
share prices, and therefore the returns.

For VFIAX, Vanguard claims a 0.05% expense ratio. These are
considered "admiral" class shares. For smaller investors, there
are "investor" class shares (VFINX) with a 0.16% expense ratio. 
This expense has gone
down over time. We shall now examine if this matches reality
and how returns deviate from the benchmark S&P 500.

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#
# Compare claimed Expense Ratios vs. Actual Expense Ratios
#
getSymbols("SPY", src="yahoo", from=as.Date(fromDate),to=toDate,adjust=T)
p0 = as.numeric(Ad(SPY[1]))
p1 = as.numeric(Ad(last(SPY[])))
tot = (p1 - p0)/p0

# Compound expenses over an expected 16 year period
expectedVFIAX = round((1.0005 ^ 16 - 1) * 100, 2)
expectedVFINX = round((1.0015 ^ 16 - 1) * 100, 2)
# Determine the percentage difference in total return 
spyOverVFIAX = (tot - funds[funds$Ticker=="VFIAX",]$totalRet)/ funds[funds$Ticker=="VFIAX",]$totalRet
spyOverVFINX = (tot - funds[funds$Ticker=="VFINX",]$totalRet)/ funds[funds$Ticker=="VFINX",]$totalRet
pctOverVFIAX = round(spyOverVFIAX / expectedVFIAX * 100,1)
pctOverVFINX = round(spyOverVFINX / expectedVFINX * 100,1)

years =  as.numeric((as.Date(funds[funds$Ticker=="VFIAX",]$endDate)) -
                     as.Date(funds[funds$Ticker=="VFIAX",]$startDate  ))/365
spy.CAGR =  (p1 / p0)^(1/years)  - 1

```

TODO: Fix expense ratio calculation

Metric | VFINX (Investor) | VFIAX (Admiral)
-------|------------------|-----------------
Claimed Expense | 0.15% | 0.05%
Cum. Exp. 16 Yrs | `r round(expectedVFINX*100,1)`% |  `r round(expectedVFIAX*100,1)`% 
Actual Expense | `r spyOverVFINX` | `r spyOverVFIAX`
Difference | `r pctOverVFINX`% | `r pctOverVFIAX`%
CAGR | `r funds[funds$Ticker=="VFINX",]$CAGR` | `r funds[funds$Ticker=="VFIAX",]$CAGR`

SPY CAGR: `r spy.CAGR`


```{r, echo=FALSE}
# Plot Difference in Adjusted Price based on Expense Ratio
plot(Ad(SPY), main="S&P 500 vs. VFIAX, VFINX",ylab="Adjusted Price")
lines(Ad(fundData$VFIAX),col="blue")
lines(Ad(fundData$VFINX),col="red")
legend("bottomright",c("SPY","VFIAX","VFINX"),fill=c("black","blue","red"))
```

In sum, expenses add up over time. Admiral shares do not
offer significant benefit over Investor shares even though the expenses are purported to be 1/3.
This illustrates how even low expenses add drag to a portfolio.

# Results

# Conclusions and Discussions

# References

This entire project code including source data can be found on GitHub ([https://github.com/wihl/stats107-project](https://github.com/wihl/stats107-project))



# Appendix A - Code

## Preparing Report

The following is the code used to prepare this report:
```{r code=readLines(knitr::purl('writeup.Rmd', documentation = 0)), eval = FALSE}

```

## Caching Stock Data

Stock data was downloaded and cached with the following code:
```{r, code=readLines("cache.R"), eval = FALSE}

```

